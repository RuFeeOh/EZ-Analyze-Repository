<!-- If items or exposure group data provided, show expandable rows mode -->
@if (items().length > 0 || data().length > 0) {
<div class="ez-table-viewport"
     #viewport>
    <table mat-table
           matSort
           [matSortActive]="defaultSortActive() || ''"
           [matSortDirection]="defaultSortDirection()"
           [matSortDisableClear]="true"
           (matSortChange)="announceSortChange($event)"
           [dataSource]="groupTableSource()"
           class="mat-elevation-z8"
           multiTemplateDataRows>
        <!-- Expand toggle column (conditionally rendered if groupColumns includes 'expand') -->
        @if (groupColumns.includes('expand')) {
        <ng-container matColumnDef="expand">
            <th mat-header-cell
                *matHeaderCellDef
                aria-label="row actions">&nbsp;</th>
            <td mat-cell
                *matCellDef="let group">
                <button mat-icon-button
                        aria-label="expand row"
                        (click)="toggle(group); $event.stopPropagation()"
                        [class.expanded]="isExpanded(group)">
                    <mat-icon>{{ isExpanded(group) ? 'keyboard_arrow_down' : 'keyboard_arrow_right' }}</mat-icon>
                </button>
            </td>
        </ng-container>
        }

        <!-- Summary columns (dynamic) -->
        @for (column of (summaryColumns().length ? summaryColumns() : defaultSummaryColumns()); track column) {
        <ng-container [matColumnDef]="columnId(column)">
            <th mat-header-cell
                *matHeaderCellDef
                [mat-sort-header]="columnId(column)"
                [disabled]="!isSortable(column)">{{ columnHeader(column) }}</th>
            <td mat-cell
                *matCellDef="let item">
                <!-- Projected cell template takes precedence -->
                <ng-container *ngIf="cellTpl; else defaultCell"
                              [ngTemplateOutlet]="cellTpl"
                              [ngTemplateOutletContext]="{ $implicit: item, column: column }"></ng-container>
                <ng-template #defaultCell>
                    @if (isPercentBadge(column)) {
                    @let raw = valueFor(item, column, 'summary');
                    @let val = (raw ?? 0);
                    <span class="ef-badge"
                          [class.ef-good]="val < 0.05"
                          [class.ef-warn]="val >= 0.05 && val < 0.2"
                          [class.ef-bad]="val >= 0.2">
                        {{ val | ezFormat: { Name: columnId(column), Format: 'percent' } }}
                    </span>
                    } @else if (isTrend(column)) {
                    @let t = valueFor(item, column, 'summary');
                    @let delta = (item?.Delta ?? 0);
                    @let deltaAbs = (delta < 0
                      ?
                      -delta
                      :
                      delta);
                      @let
                      sign=(delta> 0 ? '+' : (delta < 0
                          ? 'âˆ’'
                          : ''
                          ));
                          @let
                          prev=(item?.PrevExceedanceFraction
                          ??
                          null);
                          @let
                          prevDate=(item?.PrevDateCalculated
                          ?? ''
                          );
                          @let
                          curr=(item?.ExceedanceFraction
                          ??
                          null);
                          <span
                          class="trend"
                          [class.trend-up]="t === 'up'"
                          [class.trend-down]="t === 'down'"
                          [class.trend-flat]="t !== 'up' && t !== 'down'"
                          [matTooltip]="(prev != null && curr != null)
                                        ? ('From ' + (prev | ezFormat: { Name: 'Prev', Format: 'percent' })
                                                + ' on ' + (prevDate | ezFormat: { Name: 'DateCalculated', Format: 'date' })
                                                + ' to ' + (curr | ezFormat: { Name: 'Curr', Format: 'percent' })
                                                + ' (' + sign + (deltaAbs | ezFormat: { Name: 'Delta', Format: 'percent' }) + ')')
                                        : 'No previous value'"
                          [attr.aria-label]="(prev != null && curr != null)
                                        ? ('From ' + (prev | ezFormat: { Name: 'Prev', Format: 'percent' })
                                                + ' on ' + (prevDate | ezFormat: { Name: 'DateCalculated', Format: 'date' })
                                                + ' to ' + (curr | ezFormat: { Name: 'Curr', Format: 'percent' })
                                                + ' (' + sign + (deltaAbs | ezFormat: { Name: 'Delta', Format: 'percent' }) + ')')
                                        : 'No previous value'">
                            <mat-icon inline>
                                {{ t === 'up' ? 'arrow_upward' : (t === 'down' ? 'arrow_downward' : 'horizontal_rule') }}
                            </mat-icon>
                            <span class="trend-delta">{{ sign }}{{ deltaAbs | ezFormat: { Name: 'Delta', Format: 'percent' } }}</span>
                            </span>
                            } @else {
                            {{ valueFor(item, column, 'summary') | ezFormat: column }}
                            }
                </ng-template>
            </td>
        </ng-container>
        }

        <!-- Expanded detail -->
        <ng-container matColumnDef="expandedDetail">
            <td mat-cell
                *matCellDef="let group"
                [attr.colspan]="groupColumns.length">
                <div class="detail-wrapper"
                     [class.detail-expanded]="isExpanded(group)">
                    <table mat-table
                           [dataSource]="detailsForItem(group)"
                           class="nested-table">
                        @for (column of (detailColumns().length ? detailColumns() : displayedColumns()); track column) {
                        <ng-container [matColumnDef]="columnId(column)">
                            <th mat-header-cell
                                *matHeaderCellDef>{{ columnHeader(column) }}</th>
                            <td mat-cell
                                *matCellDef="let item">
                                <ng-container *ngIf="detailTpl; else defaultDetailCell"
                                              [ngTemplateOutlet]="detailTpl"
                                              [ngTemplateOutletContext]="{ $implicit: item, column: column }"></ng-container>
                                <ng-template #defaultDetailCell>
                                    {{ valueFor(item, column, 'detail') | ezFormat: column }}
                                </ng-template>
                            </td>
                        </ng-container>
                        }
                        <tr mat-header-row
                            *matHeaderRowDef="detailColumnIds()"></tr>
                        <tr mat-row
                            *matRowDef="let row; columns: detailColumnIds();"></tr>
                    </table>
                </div>
            </td>
        </ng-container>

        <tr mat-header-row
            *matHeaderRowDef="groupColumns"></tr>
        <tr mat-row
            *matRowDef="let row; columns: groupColumns"
            (click)="hasDetail() && toggle(row)"
            class="group-row"></tr>
        <tr mat-row
            *matRowDef="let row; columns: ['expandedDetail']; when: rowIsExpanded"
            class="detail-row"></tr>
    </table>
</div>
} @else {
<!-- Flat results mode -->
<div class="ez-table-viewport"
     #viewport>
    <table mat-table
           [dataSource]="dataTableSource()"
           class="mat-elevation-z8"
           multiTemplateDataRows>
        @for (column of displayedColumns(); track column) {
        <ng-container [matColumnDef]="columnId(column)">
            <th mat-header-cell
                *matHeaderCellDef>{{ columnHeader(column) }}</th>
            <td mat-cell
                *matCellDef="let element">
                <ng-container *ngIf="cellTpl; else flatDefaultCell"
                              [ngTemplateOutlet]="cellTpl"
                              [ngTemplateOutletContext]="{ $implicit: element, column: column }"></ng-container>
                <ng-template #flatDefaultCell>
                    {{ element[columnId(column)] }}
                </ng-template>
            </td>
        </ng-container>
        }

        <tr mat-header-row
            *matHeaderRowDef="columnIds()"></tr>
        <tr mat-row
            *matRowDef="let row; columns: columnIds();"></tr>
    </table>
</div>
}

<mat-paginator [pageSize]="pageSize()"
               [pageSizeOptions]="pageSizeOptions()"
               showFirstLastButtons>
</mat-paginator>