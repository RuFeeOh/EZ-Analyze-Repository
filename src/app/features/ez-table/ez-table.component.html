<!-- If items or exposure group data provided, show expandable rows mode -->
@if (items().length > 0 || data().length > 0) {
<div class="ez-table-viewport"
     #viewport>
    <table mat-table
           matSort
           [matSortActive]="defaultSortActive() || ''"
           [matSortDirection]="defaultSortDirection()"
           [matSortDisableClear]="true"
           (matSortChange)="announceSortChange($event)"
           [dataSource]="groupTableSource()"
           class="mat-elevation-z8"
           multiTemplateDataRows>
        <!-- Expand toggle column (conditionally rendered if groupColumns includes 'expand') -->
        @if (groupColumns.includes('expand')) {
        <ng-container matColumnDef="expand">
            <th mat-header-cell
                *matHeaderCellDef
                aria-label="row actions">&nbsp;</th>
            <td mat-cell
                *matCellDef="let group">
                <button mat-icon-button
                        aria-label="expand row"
                        (click)="toggle(group); $event.stopPropagation()"
                        [class.expanded]="isExpanded(group)">
                    <mat-icon>{{ isExpanded(group) ? 'keyboard_arrow_down' : 'keyboard_arrow_right' }}</mat-icon>
                </button>
            </td>
        </ng-container>
        }

        <!-- Summary columns (dynamic) -->
        @for (column of (summaryColumns().length ? summaryColumns() : defaultSummaryColumns()); track column) {
        <ng-container [matColumnDef]="columnId(column)">
            <th mat-header-cell
                *matHeaderCellDef
                [mat-sort-header]="columnId(column)"
                [disabled]="!isSortable(column)">{{ columnHeader(column) }}</th>
            <td mat-cell
                *matCellDef="let item">
                <!-- Projected cell template takes precedence -->
                <ng-container *ngIf="cellTpl; else defaultCell"
                              [ngTemplateOutlet]="cellTpl"
                              [ngTemplateOutletContext]="{ $implicit: item, column: column, id: columnId(column), section: 'summary', value: valueFor(item, column, 'summary') }"></ng-container>
                <ng-template #defaultCell>
                    {{ valueFor(item, column, 'summary') }}
                </ng-template>
            </td>
        </ng-container>
        }

        <!-- Expanded detail -->
        <ng-container matColumnDef="expandedDetail">
            <td mat-cell
                *matCellDef="let group"
                [attr.colspan]="groupColumns.length">
                <div class="detail-wrapper"
                     [class.detail-expanded]="isExpanded(group)">
                    <table mat-table
                           [dataSource]="detailsForItem(group)"
                           class="nested-table">
                        @for (column of (detailColumns().length ? detailColumns() : displayedColumns()); track column) {
                        <ng-container [matColumnDef]="columnId(column)">
                            <th mat-header-cell
                                *matHeaderCellDef>{{ columnHeader(column) }}</th>
                            <td mat-cell
                                *matCellDef="let item">
                                <ng-container *ngIf="detailTpl; else detailCellTplFallback"
                                              [ngTemplateOutlet]="detailTpl"
                                              [ngTemplateOutletContext]="{ $implicit: item, column: column, id: columnId(column), section: 'detail', value: valueFor(item, column, 'detail') }"></ng-container>
                                <ng-template #detailCellTplFallback>
                                    <ng-container *ngIf="cellTpl; else defaultDetailCell"
                                                  [ngTemplateOutlet]="cellTpl"
                                                  [ngTemplateOutletContext]="{ $implicit: item, column: column, id: columnId(column), section: 'detail', value: valueFor(item, column, 'detail') }"></ng-container>
                                </ng-template>
                                <ng-template #defaultDetailCell>
                                    {{ valueFor(item, column, 'detail') }}
                                </ng-template>
                            </td>
                        </ng-container>
                        }
                        <tr mat-header-row
                            *matHeaderRowDef="detailColumnIds()"></tr>
                        <tr mat-row
                            *matRowDef="let row; columns: detailColumnIds();"></tr>
                    </table>
                </div>
            </td>
        </ng-container>

        <tr mat-header-row
            *matHeaderRowDef="groupColumns"></tr>
        <tr mat-row
            *matRowDef="let row; columns: groupColumns"
            (click)="hasDetail() && toggle(row)"
            class="group-row"></tr>
        <tr mat-row
            *matRowDef="let row; columns: ['expandedDetail']; when: rowIsExpanded"
            class="detail-row"></tr>
    </table>
</div>
} @else {
<!-- Flat results mode -->
<div class="ez-table-viewport"
     #viewport>
    <table mat-table
           [dataSource]="dataTableSource()"
           class="mat-elevation-z8"
           multiTemplateDataRows>
        @for (column of displayedColumns(); track column) {
        <ng-container [matColumnDef]="columnId(column)">
            <th mat-header-cell
                *matHeaderCellDef>{{ columnHeader(column) }}</th>
            <td mat-cell
                *matCellDef="let element">
                <ng-container *ngIf="cellTpl; else flatDefaultCell"
                              [ngTemplateOutlet]="cellTpl"
                              [ngTemplateOutletContext]="{ $implicit: element, column: column, id: columnId(column), section: 'summary', value: valueFor(element, column, 'summary') }"></ng-container>
                <ng-template #flatDefaultCell>
                    {{ element[columnId(column)] }}
                </ng-template>
            </td>
        </ng-container>
        }

        <tr mat-header-row
            *matHeaderRowDef="columnIds()"></tr>
        <tr mat-row
            *matRowDef="let row; columns: columnIds();"></tr>
    </table>
</div>
}

<mat-paginator [pageSize]="pageSize()"
               [pageSizeOptions]="pageSizeOptions()"
               showFirstLastButtons>
</mat-paginator>