<div class="ef-toolbar"
     style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
     <mat-slide-toggle [checked]="showLatest()"
                       (change)="showLatest.set($event.checked)">
          Show Latest
     </mat-slide-toggle>
     <button mat-button
             type="button"
             (click)="showUndo.set(!showUndo())"
             [disabled]="false">
          {{ showUndo() ? 'Hide Undo' : 'Undo Import' }}
     </button>
     <button mat-stroked-button
             type="button"
             (click)="exportEfExcel()"
             [disabled]="false">
          Export Excel
     </button>
     <input type="text"
            placeholder="Filter by Exposure Group"
            [value]="filter()"
            (input)="filter.set(($any($event.target).value || ''))"
            style="flex:1; max-width:320px; padding:6px 10px; border:1px solid #ccc; border-radius:4px;" />
     <div class="most-recent-sample"
          *ngIf="mostRecentSampleDate$ | async as date">
          <span class="label">Most Recent Sample:</span>
          <span class="value">{{ date | date:'mediumDate' }}</span>
     </div>
</div>

@if (showUndo()) {
<div class="undo-panel"
     style="border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:12px;">
     <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
          <strong>Undo an Import</strong>
          <span style="opacity:0.7;">Select a completed import to revert</span>
     </div>
     <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <select [ngModel]="selectedJobId()"
                  (ngModelChange)="selectedJobId.set($event)"
                  style="min-width:260px; padding:6px;">
               <option [ngValue]="null">Select import…</option>
               @for (j of (jobs$ | async); track j?.id) {
               <option [ngValue]="j.id"
                       [disabled]="!j.undoAvailable || j.undoneAt">
                    {{ j.completedAt ? (j.completedAt | date:'medium') : (j.startedAt | date:'medium') }}
                    — rows: {{ j.rowsWritten ?? j.totalRows ?? '?' }}
                    {{ j.undoAvailable ? (j.undoneAt ? '— undone' : '') : 'locked' }}
               </option>
               }
          </select>
          <button mat-flat-button
                  color="warn"
                  type="button"
                  (click)="undoSelectedJob()"
                  [disabled]="!selectedJobId() || undoBusy()">
               {{ undoBusy() ? 'Reverting…' : 'Undo Selected Import' }}
          </button>
     </div>
     <div style="font-size:12px; opacity:0.7; margin-top:6px;">
          Undo will remove rows from the selected import and restore any previously replaced rows.
     </div>
</div>
}

<div class="ef-legend"
     style="display:flex; align-items:center; gap:12px; margin: 4px 0 8px 0; font-size: 12px;">
     <span>Legend:</span>
     <button type="button"
             class="ef-badge ef-good"
             [class.active]="bucket() === 'good'"
             [style.opacity]="bucket() && bucket() !== 'good' ? 0.35 : 1"
             (click)="bucket.set(bucket() === 'good' ? '' : 'good')">
          &lt; 5%
     </button>
     <button type="button"
             class="ef-badge ef-warn"
             [class.active]="bucket() === 'warn'"
             [style.opacity]="bucket() && bucket() !== 'warn' ? 0.35 : 1"
             (click)="bucket.set(bucket() === 'warn' ? '' : 'warn')">
          5% – 20%
     </button>
     <button type="button"
             class="ef-badge ef-bad"
             [class.active]="bucket() === 'bad'"
             [style.opacity]="bucket() && bucket() !== 'bad' ? 0.35 : 1"
             (click)="bucket.set(bucket() === 'bad' ? '' : 'bad')">
          ≥ 20%
     </button>
     <div class="custom-threshold-wrapper"
          #customThresholdWrapper
          style="display:inline-flex; align-items:center; gap:4px;">
          <button type="button"
                  class="ef-badge ef-custom"
                  [class.active]="bucket() === 'custom'"
                  [style.opacity]="bucket() && bucket() !== 'custom' ? 0.35 : 1"
                  (click)="toggleCustomBucket()">
               <span class="symbol">≥</span>
               <span class="value">{{ (customThreshold() * 100) | number:'1.1-1' }}</span><span class="suffix">%</span>
          </button>
          <button type="button"
                  class="edit-custom-btn"
                  (click)="toggleEditCustom($event)"
                  aria-label="Edit custom threshold">{{ editingCustom() ? '✕' : '✎' }}</button>
          @if (editingCustom()) {
          <span class="custom-edit-pop">
               <div class="custom-editor">
                    <label class="custom-row">
                         <span class="label">Threshold</span>
                         <input type="number"
                                min="0"
                                max="100"
                                step="0.1"
                                inputmode="decimal"
                                [value]="(customThreshold()*100) | number:'1.0-1'"
                                (input)="updateCustomFromInput($any($event.target).value)"
                                class="threshold-input" />
                         <span class="suffix">%</span>
                    </label>
                    <div class="slider-row">
                         <mat-slider min="0"
                                     max="100"
                                     step="0.5"
                                     class="threshold-slider">
                              <input matSliderThumb
                                     [value]="customThreshold()*100"
                                     (input)="updateCustomFromSlider($any($event.target).value)" />
                         </mat-slider>
                         <span class="current-val">{{ (customThreshold()*100) | number:'1.0-1' }}%</span>
                    </div>
                    <div class="actions">
                         <button type="button"
                                 class="edit-custom-btn close-btn"
                                 (click)="editingCustom.set(false)">Close</button>
                    </div>
               </div>
          </span>
          }
     </div>
     <span style="opacity:0.7;">(lower is better)</span>
     <span style="opacity:0.7;">Trend: <mat-icon inline
                    style="vertical-align: middle; color:#dc2626;">arrow_upward</mat-icon> bad, <mat-icon inline
                    style="vertical-align: middle; color:#16a34a;">arrow_downward</mat-icon> good</span>

</div>

@let efItems = (showLatest() ? (filteredLatestEfItems$ | async) : (filteredEfItems$ | async));

<div class="table-wrapper"
     style="position:relative;">
     <div class="spinner-overlay"
          *ngIf="!efItems"
          style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index: 2;">
          <mat-progress-spinner mode="indeterminate"
                                diameter="48"></mat-progress-spinner>
     </div>

     <ez-table [items]="efItems ?? []"
               [summaryColumns]="efSummaryColumns"
               [detailColumns]="efDetailColumns"
               [detailFor]="efDetailForItem"
               [filterText]="filter()"
               filterKey="ExposureGroup"
               defaultSortActive="ExposureGroup"
               defaultSortDirection="asc">
          <ng-template #cell
                       let-item
                       let-col="column"
                       let-id="id"
                       let-section="section"
                       let-value="value">
               <ng-container [ngSwitch]="id">
                    <ng-container *ngSwitchCase="'ExceedanceFraction'">
                         <span class="ef-badge"
                               [class.ef-good]="(value ?? 0) < 0.05"
                               [class.ef-warn]="(value ?? 0) >= 0.05 && (value ?? 0) < 0.2"
                               [class.ef-bad]="(value ?? 0) >= 0.2">
                              {{ (value ?? 0) | percent:'1.1-1' }}
                         </span>
                    </ng-container>
                    <ng-container *ngSwitchCase="'Trend'">
                         <span class="trend"
                               [class.trend-up]="item?.Trend === 'up'"
                               [class.trend-down]="item?.Trend === 'down'"
                               [class.trend-flat]="item?.Trend !== 'up' && item?.Trend !== 'down'">
                              <mat-icon inline
                                        [matTooltip]="(item?.PrevExceedanceFraction != null && item?.ExceedanceFraction != null)
                                                 ? ('From ' + (item?.PrevExceedanceFraction | percent:'1.1-1')
                                                    + ' on ' + (item?.PrevDateCalculated | date:'mediumDate')
                                                    + ' to ' + (item?.ExceedanceFraction | percent:'1.1-1')
                                                    + ' (' + ((item?.Delta ?? 0) > 0 ? '+' : ((item?.Delta ?? 0) < 0 ? '−' : ''))
                                                    + (((item?.Delta ?? 0) < 0 ? (-(item?.Delta ?? 0)) : (item?.Delta ?? 0)) | percent:'1.1-1') + ')')
                                                 : 'No previous value'"
                                        [attr.aria-label]="(item?.PrevExceedanceFraction != null && item?.ExceedanceFraction != null)
                                                 ? ('From ' + (item?.PrevExceedanceFraction | percent:'1.1-1')
                                                    + ' on ' + (item?.PrevDateCalculated | date:'mediumDate')
                                                    + ' to ' + (item?.ExceedanceFraction | percent:'1.1-1')
                                                    + ' (' + ((item?.Delta ?? 0) > 0 ? '+' : ((item?.Delta ?? 0) < 0 ? '−' : ''))
                                                    + (((item?.Delta ?? 0) < 0 ? (-(item?.Delta ?? 0)) : (item?.Delta ?? 0)) | percent:'1.1-1') + ')')
                                                 : 'No previous value'">
                                   {{ item?.Trend === 'up' ? 'arrow_upward' : (item?.Trend === 'down' ? 'arrow_downward' : 'horizontal_rule') }}
                              </mat-icon>
                              <span class="trend-delta">
                                   {{ (item?.Delta ?? 0) > 0 ? '+' : ((item?.Delta ?? 0) < 0
                                     ? '−'
                                     : ''
                                     )
                                     }}&nbsp;{{
                                     ((item?.Delta
                                     ??
                                     0)
                                     <
                                     0
                                     ?
                                     (-(item?.Delta
                                     ??
                                     0))
                                     :
                                     (item?.Delta
                                     ??
                                     0))
                                     |
                                     percent:'1.1-1'
                                     }}
                                     </span>
                              </span>
                    </ng-container>
                    <ng-container *ngSwitchCase="'DateCalculated'">{{ value | date:'mediumDate' }}</ng-container>
                    <ng-container *ngSwitchCase="'SampleDate'">{{ value | date:'mediumDate' }}</ng-container>
                    <ng-container *ngSwitchCase="'TWA'">{{ value | number:'1.3-3' }}</ng-container>
                    <ng-container *ngSwitchDefault>{{ value }}</ng-container>
               </ng-container>
          </ng-template>
     </ez-table>
</div>