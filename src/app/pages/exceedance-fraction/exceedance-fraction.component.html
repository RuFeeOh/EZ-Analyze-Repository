<div class="ef-toolbar">
     <div class="left">

          <button mat-flat-button
                  color="warn"
                  type="button"
                  (click)="deleteSelectedGroups()"
                  [disabled]="!selection.hasValue() || deleting()">
               <span class="btn-content">
                    <mat-icon *ngIf="!deleting()">delete</mat-icon>
                    <mat-progress-spinner *ngIf="deleting()"
                                          class="btn-spinner"
                                          mode="indeterminate"
                                          diameter="20"
                                          strokeWidth="3"></mat-progress-spinner>
                    <span class="btn-label">Delete ({{ selection.selected.length }})</span>
               </span>
          </button>
          <mat-button-toggle-group [value]="showLatest() ? 'latest' : 'history'"
                                   (change)="showLatest.set(($any($event).value ?? $any($event)?.source?.value) === 'latest')"
                                   aria-label="Select EF view">
               <mat-button-toggle value="latest">
                    <mat-icon inline>check_circle</mat-icon>
                    <span>Latest</span>
               </mat-button-toggle>
               <mat-button-toggle value="history">
                    <mat-icon inline>history</mat-icon>
                    <span>History</span>
               </mat-button-toggle>
          </mat-button-toggle-group>
          <button mat-stroked-button
                  type="button"
                  [matMenuTriggerFor]="moreMenu">
               <mat-icon>more_vert</mat-icon>
               <span>More</span>
          </button>

     </div>

     <div class="right">
          <div class="most-recent-sample">
               <span class="label">Most Recent Sample:</span>
               <span class="value">{{ (mostRecentSampleDate$ | async) | date:'mediumDate' }}</span>
          </div>
     </div>
</div>

<mat-menu #moreMenu="matMenu">
     <button mat-menu-item
             type="button"
             (click)="exportEfExcel()">
          <mat-icon>grid_on</mat-icon>
          <span>Export Excel</span>
     </button>
     <button mat-menu-item
             type="button"
             (click)="showUndo.set(!showUndo())">
          <mat-icon>undo</mat-icon>
          <span>{{ showUndo() ? 'Hide Undo' : 'Undo Import' }}</span>
     </button>

</mat-menu>

@if (showUndo()) {
<div class="undo-panel"
     style="border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:12px;">
     <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
          <strong>Undo an Import</strong>
          <span style="opacity:0.7;">Select a completed import to revert</span>
     </div>
     <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <select [ngModel]="selectedJobId()"
                  (ngModelChange)="selectedJobId.set($event)"
                  style="min-width:260px; padding:6px;">
               <option [ngValue]="null">Select import…</option>
               @for (j of (jobs$ | async); track j?.id) {
               <option [ngValue]="j.id"
                       [disabled]="!j.undoAvailable || j.undoneAt">
                    {{ j.completedAt ? (j.completedAt | date:'medium') : (j.startedAt | date:'medium') }}
                    — rows: {{ j.rowsWritten ?? j.totalRows ?? '?' }}
                    {{ j.undoAvailable ? (j.undoneAt ? '— undone' : '') : 'locked' }}
               </option>
               }
          </select>
          <button mat-flat-button
                  color="warn"
                  type="button"
                  (click)="undoSelectedJob()"
                  [disabled]="!selectedJobId() || undoBusy()">
               {{ undoBusy() ? 'Reverting…' : 'Undo Selected Import' }}
          </button>
     </div>
     <div style="font-size:12px; opacity:0.7; margin-top:6px;">
          Undo will remove rows from the selected import and restore any previously replaced rows.
     </div>
</div>
}


<div class="ef-actions">

     <mat-form-field appearance="outline"
                     class="filter-field">
          <mat-icon matPrefix>search</mat-icon>
          <input matInput
                 placeholder="Filter by Exposure Group"
                 [value]="filter()"
                 (input)="filter.set(($any($event.target).value || ''))" />
          <button mat-icon-button
                  class="compact"
                  matSuffix
                  type="button"
                  *ngIf="filter()"
                  aria-label="Clear filter"
                  (click)="clearFilter()">
               <mat-icon>close</mat-icon>
          </button>
     </mat-form-field>
     @if (agentFilter()) {
     <button mat-stroked-button
             type="button"
             class="agent-chip"
             (click)="clearAgentFilter()"
             matTooltip="Clear agent filter">
          <mat-icon inline>person</mat-icon>
          <span class="chip-label">{{ agentFilter() }}</span>
          <mat-icon inline>close</mat-icon>
     </button>
     }
</div>
<div class="ef-legend">
     <span>Legend:</span>
     <button type="button"
             class="ef-badge ef-good"
             [class.active]="bucket() === 'good'"
             [style.opacity]="bucket() && bucket() !== 'good' ? 0.35 : 1"
             (click)="bucket.set(bucket() === 'good' ? '' : 'good')">
          &lt; 5%
     </button>
     <button type="button"
             class="ef-badge ef-warn"
             [class.active]="bucket() === 'warn'"
             [style.opacity]="bucket() && bucket() !== 'warn' ? 0.35 : 1"
             (click)="bucket.set(bucket() === 'warn' ? '' : 'warn')">
          5% – 20%
     </button>
     <button type="button"
             class="ef-badge ef-bad"
             [class.active]="bucket() === 'bad'"
             [style.opacity]="bucket() && bucket() !== 'bad' ? 0.35 : 1"
             (click)="bucket.set(bucket() === 'bad' ? '' : 'bad')">
          ≥ 20%
     </button>
     <div class="custom-threshold-wrapper"
          #customThresholdWrapper
          style="display:inline-flex; align-items:center; gap:4px;">
          <button type="button"
                  class="ef-badge ef-custom"
                  [class.active]="bucket() === 'custom'"
                  [style.opacity]="bucket() && bucket() !== 'custom' ? 0.35 : 1"
                  (click)="toggleCustomBucket()">
               <span class="symbol">≥</span>
               <span class="value">{{ (customThreshold() * 100) | number:'1.1-1' }}</span><span class="suffix">%</span>
          </button>
          <button type="button"
                  class="edit-custom-btn"
                  (click)="toggleEditCustom($event)"
                  aria-label="Edit custom threshold">{{ editingCustom() ? '✕' : '✎' }}</button>
          @if (editingCustom()) {
          <span class="custom-edit-pop">
               <div class="custom-editor">
                    <label class="custom-row">
                         <span class="label">Threshold</span>
                         <input type="number"
                                min="0"
                                max="100"
                                step="0.1"
                                inputmode="decimal"
                                [value]="(customThreshold()*100) | number:'1.0-1'"
                                (input)="updateCustomFromInput($any($event.target).value)"
                                class="threshold-input" />
                         <span class="suffix">%</span>
                    </label>
                    <div class="slider-row">
                         <mat-slider min="0"
                                     max="100"
                                     step="0.5"
                                     class="threshold-slider">
                              <input matSliderThumb
                                     [value]="customThreshold()*100"
                                     (input)="updateCustomFromSlider($any($event.target).value)" />
                         </mat-slider>
                         <span class="current-val">{{ (customThreshold()*100) | number:'1.0-1' }}%</span>
                    </div>
                    <div class="actions">
                         <button type="button"
                                 class="edit-custom-btn close-btn"
                                 (click)="editingCustom.set(false)">Close</button>
                    </div>
               </div>
          </span>
          }
     </div>
     <span style="opacity:0.7;">(lower is better)</span>
     <span style="opacity:0.7;">Trend: <mat-icon inline
                    style="vertical-align: middle; color:#dc2626;">arrow_upward</mat-icon> bad, <mat-icon inline
                    style="vertical-align: middle; color:#16a34a;">arrow_downward</mat-icon> good</span>

</div>
@let efItems = (showLatest() ? (filteredLatestEfItems$ | async) : (filteredEfItems$ | async));

<div class="table-wrapper"
     style="position:relative;">
     @if (!efItems) {
     <div class="spinner-overlay"
          style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index: 2;">
          <mat-progress-spinner mode="indeterminate"
                                diameter="48"></mat-progress-spinner>
     </div>
     }

     <ez-table [items]="efItems ?? []"
               [summaryColumns]="efSummaryColumnsWithSelect"
               [detailColumns]="efDetailColumns"
               [detailFor]="efDetailForItem"
               [filterText]="filter()"
               filterKey="ExposureGroup"
               defaultSortActive="ExposureGroup"
               defaultSortDirection="asc">
          <ng-template #headerCell
                       let-id="id">
               <ng-container [ngSwitch]="id">
                    <ng-container *ngSwitchCase="'Select'">
                         <mat-checkbox (change)="$event ? toggleAllRows(efItems ?? []) : null"
                                       [checked]="isAllSelected(efItems ?? [])"
                                       [indeterminate]="selection.hasValue() && !isAllSelected(efItems ?? [])"
                                       [aria-label]="checkboxLabel()">
                         </mat-checkbox>
                    </ng-container>
               </ng-container>
          </ng-template>
          <ng-template #cell
                       let-item
                       let-col="column"
                       let-id="id"
                       let-section="section"
                       let-value="value">
               <ng-container [ngSwitch]="id">
                    <ng-container *ngSwitchCase="'Select'">
                         <mat-checkbox (click)="$event.stopPropagation()"
                                       (change)="$event ? selection.toggle(item) : null"
                                       [checked]="selection.isSelected(item)"
                                       [aria-label]="checkboxLabel(item)">
                         </mat-checkbox>
                    </ng-container>
                    <ng-container *ngSwitchCase="'ExceedanceFraction'">
                         <span class="ef-badge"
                               [class.ef-good]="(value ?? 0) < 0.05"
                               [class.ef-warn]="(value ?? 0) >= 0.05 && (value ?? 0) < 0.2"
                               [class.ef-bad]="(value ?? 0) >= 0.2">
                              {{ (value ?? 0) | percent:'1.1-1' }}
                         </span>
                    </ng-container>
                    <ng-container *ngSwitchCase="'Trend'">
                         <span class="trend"
                               [class.trend-up]="item?.Trend === 'up'"
                               [class.trend-down]="item?.Trend === 'down'"
                               [class.trend-flat]="item?.Trend !== 'up' && item?.Trend !== 'down'">
                              <mat-icon inline
                                        [matTooltip]="(item?.PrevExceedanceFraction != null && item?.ExceedanceFraction != null)
                                                 ? ('From ' + (item?.PrevExceedanceFraction | percent:'1.1-1')
                                                    + ' on ' + (item?.PrevDateCalculated | date:'mediumDate')
                                                    + ' to ' + (item?.ExceedanceFraction | percent:'1.1-1')
                                                    + ' (' + ((item?.Delta ?? 0) > 0 ? '+' : ((item?.Delta ?? 0) < 0 ? '−' : ''))
                                                    + (((item?.Delta ?? 0) < 0 ? (-(item?.Delta ?? 0)) : (item?.Delta ?? 0)) | percent:'1.1-1') + ')')
                                                 : 'No previous value'"
                                        [attr.aria-label]="(item?.PrevExceedanceFraction != null && item?.ExceedanceFraction != null)
                                                 ? ('From ' + (item?.PrevExceedanceFraction | percent:'1.1-1')
                                                    + ' on ' + (item?.PrevDateCalculated | date:'mediumDate')
                                                    + ' to ' + (item?.ExceedanceFraction | percent:'1.1-1')
                                                    + ' (' + ((item?.Delta ?? 0) > 0 ? '+' : ((item?.Delta ?? 0) < 0 ? '−' : ''))
                                                    + (((item?.Delta ?? 0) < 0 ? (-(item?.Delta ?? 0)) : (item?.Delta ?? 0)) | percent:'1.1-1') + ')')
                                                 : 'No previous value'">
                                   {{ item?.Trend === 'up' ? 'arrow_upward' : (item?.Trend === 'down' ? 'arrow_downward' : 'horizontal_rule') }}
                              </mat-icon>
                              <span class="trend-delta">
                                   {{ (item?.Delta ?? 0) > 0 ? '+' : ((item?.Delta ?? 0) < 0
                                     ? '−'
                                     : ''
                                     )
                                     }}&nbsp;{{
                                     ((item?.Delta
                                     ??
                                     0)
                                     <
                                     0
                                     ?
                                     (-(item?.Delta
                                     ??
                                     0))
                                     :
                                     (item?.Delta
                                     ??
                                     0))
                                     |
                                     percent:'1.1-1'
                                     }}
                                     </span>
                              </span>
                    </ng-container>
                    <ng-container *ngSwitchCase="'DateCalculated'">{{ value | date:'mediumDate' }}</ng-container>
                    <ng-container *ngSwitchCase="'SampleDate'">{{ value | date:'mediumDate' }}</ng-container>
                    <ng-container *ngSwitchCase="'TWA'">{{ value | number:'1.3-3' }}</ng-container>
                    <ng-container *ngSwitchCase="'Actions'">
                         @if (section === 'detail') {
                         <button mat-icon-button
                                 color="warn"
                                 type="button"
                                 (click)="deleteSample(item, $event)"
                                 [disabled]="isSampleDeleting(item)"
                                 matTooltip="Delete sample">
                              <mat-icon *ngIf="!isSampleDeleting(item)">delete</mat-icon>
                              <mat-icon *ngIf="isSampleDeleting(item)">hourglass_top</mat-icon>
                         </button>
                         }
                    </ng-container>
                    <ng-container *ngSwitchDefault>{{ value }}</ng-container>
               </ng-container>
          </ng-template>
     </ez-table>
</div>