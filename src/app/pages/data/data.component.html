<input type="file"
       class="file-input"
       (change)="onFileChange($event)"
       #fileUpload>

<div class="toolbar">
    <div class="actions">
        <button mat-stroked-button
                color="primary"
                (click)="fileUpload.click()">
            <mat-icon>attach_file</mat-icon>
            <span>Upload</span>
        </button>
        <button mat-stroked-button
                [disabled]="totalCount() === 0"
                (click)="openMappingDialog()"
                matTooltip="Review or adjust column mapping">
            <mat-icon>view_column</mat-icon>
            <span>Mapping</span>
        </button>
        <button matButton="filled"
                (click)="saveSampleInfo()"
                [disabled]="validCount() === 0 || hasInvalidRows()">
            <mat-icon>save</mat-icon>
            <span>Save</span>
        </button><button matButton="tonal"
                *ngIf="hasInvalidRows()"
                (click)="openFixInvalidRows()"
                matTooltip="Edit only invalid rows inline">
            <mat-icon>build</mat-icon>
            <span>Fix Invalid</span>
        </button>
    </div>
    <div class="status"
         *ngIf="totalCount() > 0">
        <mat-chip-set>
            <mat-chip [disabled]="true"
                      matTooltip="Selected file name">{{ fileName() || 'File' }}</mat-chip>
            <mat-chip [disabled]="true"
                      matTooltip="Valid / Total rows">{{ validCount() }}/{{ totalCount() }} rows</mat-chip>
            <mat-chip *ngIf="hasInvalidRows()"
                      color="warn"
                      [matTooltip]="errorTooltip()">{{ invalidCount() }} rows invalid</mat-chip>
        </mat-chip-set>
    </div>
    <div class="ef"
         *ngIf="exceedanceFraction as ef">
        <span class="ef-label">Overall EF:</span>
        <span class="ef-value">{{ ef | number:'1.2-4' }}</span>
    </div>

</div>


<table mat-table
       [dataSource]="displayData()"
       multiTemplateDataRows
       class="mat-elevation-z8">
    @for (column of columnsToDisplay; track column) {
    <ng-container [matColumnDef]="column">
        <th mat-header-cell
            *matHeaderCellDef>{{ headerLabels[column] || column }}</th>
        <td mat-cell
            *matCellDef="let element">
            @switch (column) {
            @case ('SampleDate') {
            {{ element[column] | date:'dd-MMM-yyyy' }}
            }
            @case ('TWA'){
            {{ element[column] === undefined ? '' : (element[column] | number:'1.2-3') }}
            }
            @default {
            {{ element[column] }}
            }
            }
        </td>
    </ng-container>
    }
    <!-- Errors column -->
    <ng-container matColumnDef="Errors">
        <th mat-header-cell
            *matHeaderCellDef>Errors</th>
        <td mat-cell
            *matCellDef="let element">
            <span *ngIf="element.__invalid">
                {{ (element.__errors || []).join('; ') }}
            </span>
        </td>
    </ng-container>
    <tr mat-header-row
        *matHeaderRowDef="columnsToDisplayWithExpand; sticky: true"></tr>
    <tr mat-row
        *matRowDef="let element; columns: columnsToDisplayWithExpand;"
        class="example-element-row"
        [class.invalid-row]="element.__invalid"
        [class.recent-fixed]="!element.__invalid && element.__recentFixed">
    </tr>
</table>

<!-- Parsing overlay -->
<div class="overlay"
     *ngIf="isParsing()">
    <div class="overlay-card">
        <mat-progress-spinner *ngIf="parsePercent() === null"
                              mode="indeterminate"
                              diameter="42"></mat-progress-spinner>
        <mat-progress-bar *ngIf="parsePercent() !== null"
                          mode="determinate"
                          [value]="parsePercent() || 0"></mat-progress-bar>
        <div class="overlay-label">{{ parseLabel() || 'Processingâ€¦' }}</div>
    </div>

</div>